<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Incontri - Utenti</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <div class="container">
    <h1>üîç Scopri Utenti</h1>
    <div class="card-grid" id="usersContainer"></div>
  </div>

  <script>
    const userId = localStorage.getItem("userId");
    const userRole = localStorage.getItem("userRole"); // salvato al login

    async function loadUsers() {
      try {
        const res = await fetch('/api/users');
        const users = await res.json();
        const container = document.getElementById("usersContainer");
        container.innerHTML = "";

        users.forEach(user => {
          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <img class="profile-photo" src="${user.photo}" alt="${user.nickname}" />
            <h3>${user.nickname} ${user.isVIP ? '<span class="vip-badge">VIP</span>' : ''}</h3>
            ${user.featured ? '<div style="color: gold;">üåü In Evidenza</div>' : ''}
            ${user.isFake ? '<div style="color: orange;">ü§ñ Profilo Fake</div>' : ''}
            <p>${user.description || ''}</p>
            ${userRole === 'admin' ? adminControls(user) : ''}
          `;

          container.appendChild(card);
        });
      } catch (err) {
        console.error("Errore nel caricamento utenti:", err);
      }
    }

    function adminControls(user) {
      return `
        <button class="btn" onclick="toggleVIP('${user._id}')">${user.isVIP ? 'Rimuovi VIP' : 'Rendi VIP'}</button>
        <button class="btn" onclick="toggleFeatured('${user._id}')">${user.featured ? 'Nascondi' : 'Evidenzia'}</button>
        <button class="btn like-btn" onclick="toggleFake('${user._id}')">${user.isFake ? 'Rendi Reale' : 'Rendi Fake'}</button>
        <button class="btn" onclick="deleteUser('${user._id}')">‚ùå Elimina</button>
      `;
    }

    async function updateUser(userId, updates) {
      try {
        await fetch(`/admin/user/${userId}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': localStorage.getItem('userId')
          },
          body: JSON.stringify(updates)
        });
        loadUsers();
      } catch (err) {
        console.error('Errore aggiornamento:', err);
      }
    }

    function toggleVIP(id) {
      updateUser(id, { isVIP: true });
    }

    function toggleFeatured(id) {
      updateUser(id, { featured: true });
    }

    function toggleFake(id) {
      updateUser(id, { isFake: true });
    }

    async function deleteUser(id) {
      if (!confirm('Sei sicuro di voler eliminare questo utente?')) return;
      try {
        await fetch(`/admin/user/${id}`, {
          method: 'DELETE',
          headers: {
            'x-user-id': localStorage.getItem('userId')
          }
        });
        loadUsers();
      } catch (err) {
        console.error('Errore eliminazione:', err);
      }
    }

    loadUsers();
  </script>

</body>
</html>
